app-id: com.thebrokenrail.MCPIReborn

# No Separate Locales
separate-locales: false

# MCPI Itself Is Proprietary
tags:
  - proprietary

# Runtime/SDK
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk

# Startup Command
command: minecraft-pi-reborn-client

# Permissions
finish-args:
  - --persist=.minecraft-pi
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --share=network
  - --device=dri
  - --socket=pulseaudio
  - --allow=multiarch
  - --env=APPDIR=/app

# MCPI-Reborn Git
x-mcpi-reborn-git: &mcpi-reborn-git
  type: git
  url: https://gitea.thebrokenrail.com/TheBrokenRail/minecraft-pi-reborn.git
  commit: 6ba86b9193054b27907d2083177ed8589cd10bc9
  disable-shallow-clone: true

# Build
modules:
  # QEMU
  - name: qemu-arm
    config-opts:
      - --prefix=/app
      - --target-list=arm-linux-user
      - --enable-linux-user
      - --disable-debug-info
      - --disable-bsd-user
      - --disable-werror
      - --disable-system
      - --disable-tools
      - --disable-docs
      - --disable-gtk
      - --disable-gnutls
      - --disable-nettle
      - --disable-gcrypt
      - --disable-glusterfs
      - --disable-libnfs
      - --disable-libiscsi
      - --disable-vnc
      - --disable-kvm
      - --disable-libssh
      - --disable-libxml2
      - --disable-vde
      - --disable-sdl
      - --disable-opengl
      - --disable-xen
      - --disable-fdt
      - --disable-vhost-net
      - --disable-vhost-crypto
      - --disable-vhost-user
      - --disable-vhost-vsock
      - --disable-vhost-scsi
      - --disable-tpm
      - --disable-qom-cast-debug
      - --disable-capstone
      - --disable-zstd
      - --disable-linux-io-uring
      - --disable-bpf
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.qemu.org/qemu-6.2.0.tar.xz
        sha256: 68e15d8e45ac56326e0b9a4afa8b49a3dfe8aba3488221d098c84698bca65b45
      - type: patch
        path: qemu-arm.patch
  # patchelf
  - name: patchelf
    sources:
      - type: git
        url: https://github.com/NixOS/patchelf.git
        tag: 0.14.3
  # MCPI-Reborn Native Code
  - name: minecraft-pi-reborn-native
    buildsystem: cmake-ninja
    config-opts:
      - -DMCPI_IS_MIXED_BUILD=ON
      - -DMCPI_BUILD_MODE=native
      - -DMCPI_OPEN_SOURCE_ONLY=ON
      # Use GCC
      - -DCMAKE_C_COMPILER=gcc
      - -DCMAKE_CXX_COMPILER=g++
      # App ID
      - -DMCPI_APP_ID=com.thebrokenrail.MCPIReborn
    sources:
      - *mcpi-reborn-git
    # Nested Build
    modules:
      # FreeImage
      - name: freeimage
        no-autogen: true
        build-options:
          cxxflags: -std=c++14
          arch:
            aarch64:
              # See https://sourceforge.net/p/freeimage/bugs/325/
              cflags: -fPIC -DPNG_ARM_NEON_OPT=0
              cxxflags: -fPIC
        make-args:
          - DESTDIR=/app
        sources:
          - type: archive
            url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
            sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
          - type: shell
            commands:
              - sed -i 's|-o root -g root ||' ./Makefile.gnu
              - sed -i 's|/usr|/app|' ./Makefile.gnu
  # MCPI-Reborn ARM Code
  - name: minecraft-pi-reborn-arm
    buildsystem: cmake-ninja
    config-opts:
      - -DMCPI_IS_MIXED_BUILD=ON
      - -DMCPI_BUILD_MODE=arm
      - -DMCPI_OPEN_SOURCE_ONLY=ON
      # ARM Toolchain
      - -DCMAKE_SYSTEM_NAME=Linux
      - -DCMAKE_C_COMPILER=/run/build/minecraft-pi-reborn-arm/armhf-toolchain/bin/arm-none-linux-gnueabihf-gcc
      - -DCMAKE_CXX_COMPILER=/run/build/minecraft-pi-reborn-arm/armhf-toolchain/bin/arm-none-linux-gnueabihf-g++
      - -DCMAKE_SYSTEM_PROCESSOR=arm
      # Specify Bundled ARMHF Sysroot
      - -DMCPI_CUSTOM_BUNDLED_ARMHF_SYSROOT=/run/build/minecraft-pi-reborn-arm/armhf-sysroot
      # App ID
      - -DMCPI_APP_ID=com.thebrokenrail.MCPIReborn
    build-options:
      env:
        # The Runtime Automatically Includes An x86_64-Only Flag, So Reset Flags
        CFLAGS: ''
        CXXFLAGS: ''
    sources:
      - *mcpi-reborn-git
      # ARM Toolchain
      - type: archive
        only-arches:
          - x86_64
        url: https://developer.arm.com/-/media/Files/downloads/gnu/11.2-2022.02/binrel/gcc-arm-11.2-2022.02-x86_64-arm-none-linux-gnueabihf.tar.xz
        sha256: c254f7199261fe76c32ef42187502839bda7efad0a66646cf739d074eff45fad
        dest: armhf-toolchain
      - type: archive
        only-arches:
          - aarch64
        url: https://developer.arm.com/-/media/Files/downloads/gnu/11.2-2022.02/binrel/gcc-arm-11.2-2022.02-aarch64-arm-none-linux-gnueabihf.tar.xz
        sha256: c5603772af016008ddacb7e475dc226d0cccdf069925dfded43e452a59774fc3
        dest: armhf-toolchain
      # ARM Sysroot
      - type: shell
        commands:
          - mkdir armhf-sysroot
          - mkdir armhf-sysroot/lib
          - mkdir -p armhf-sysroot/usr/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/ld-linux-armhf.so.3 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libanl.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libnss_hesiod.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libdl.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libc_malloc_debug.so.0 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libpcprofile.so armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libthread_db.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libBrokenLocale.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libmemusage.so armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libc.so.6 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libresolv.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/librt.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libutil.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/usr/lib/libgcc_s.so.1 armhf-sysroot/usr/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libnsl.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libcrypt.so.1 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libm.so.6 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libpthread.so.0 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libnss_compat.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libnss_dns.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/lib/libnss_files.so.2 armhf-sysroot/lib
          - cp -aL armhf-toolchain/arm-none-linux-gnueabihf/libc/usr/lib/libstdc++.so.6 armhf-sysroot/usr/lib
  # Download MCPI Separately At Installation-Time
  - name: mcpi
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra /app/bin/apply_extra
      # Allow Starting MCPI
      - ln -s ../../extra/minecraft-pi /app/lib/minecraft-pi-reborn-client/minecraft-pi
    sources:
      - type: extra-data
        filename: mcpi.tar.gz
        url: https://s3.amazonaws.com/assets.minecraft.net/pi/minecraft-pi-0.1.1.tar.gz
        sha256: e0d68918874cdd403de1fd399380ae2930913fcefdbf60a3fbfebb62e2cfacab
        size: 1459472
      - type: script
        dest-filename: apply_extra
        commands:
          - tar -xf mcpi.tar.gz --strip-components 1
          - rm -f mcpi.tar.gz

# Cleanup
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
